---
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import Button from '../../components/ui/Button.astro';

export async function getStaticPaths() {
  const pages = await getCollection('webcomic');

  // Sort pages by chapter and page number
  const sortedPages = pages.sort((a, b) => {
    if (a.data.chapter !== b.data.chapter) {
      return a.data.chapter - b.data.chapter;
    }
    return (a.data.page || 0) - (b.data.page || 0);
  });

  return sortedPages.map((page, index) => ({
    params: { slug: page.slug },
    props: {
      page,
      prevPage: index > 0 ? sortedPages[index - 1] : null,
      nextPage: index < sortedPages.length - 1 ? sortedPages[index + 1] : null,
      totalPages: sortedPages.length,
      currentIndex: index + 1,
    },
  }));
}

interface Props {
  page: CollectionEntry<'webcomic'>;
  prevPage: CollectionEntry<'webcomic'> | null;
  nextPage: CollectionEntry<'webcomic'> | null;
  totalPages: number;
  currentIndex: number;
}

const { page, prevPage, nextPage, totalPages, currentIndex } = Astro.props;
const { Content } = await page.render();
---

<Layout
  title={`${page.data.title} | Webcomic | Cosmic Ocean`}
  description={`Chapter ${page.data.chapter}, Page ${page.data.page || '?'} — ${page.data.title}`}
  room="webcomic"
>
  <article class="min-h-screen px-6 py-24">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <header class="mb-8 text-center">
        <p class="text-sm text-text-muted mb-2">
          Chapter {page.data.chapter} · Page {page.data.page || '?'}
        </p>
        <h1 class="text-2xl md:text-3xl font-display font-light text-text-primary">
          {page.data.title}
        </h1>
      </header>

      <!-- Comic Page Image -->
      <div class="comic-container relative mb-8">
        <div class="aspect-[3/4] max-w-2xl mx-auto rounded-lg bg-surface border border-wisteria/20 flex items-center justify-center overflow-hidden">
          {page.data.image ? (
            <Image
              src={page.data.image}
              alt={page.data.title}
              width={800}
              height={1067}
              class="w-full h-full object-contain"
              loading="eager"
            />
          ) : (
            <div class="text-center p-8">
              <span class="text-8xl text-wisteria/30 font-display font-light block mb-4">◇</span>
              <p class="text-text-muted">Page image coming soon</p>
            </div>
          )}
        </div>

        <!-- Click navigation areas -->
        <a
          href={prevPage ? `/webcomic/${prevPage.slug}` : '#'}
          class={`absolute left-0 top-0 bottom-0 w-1/3 flex items-center justify-start pl-4 opacity-0 hover:opacity-100 transition-opacity ${!prevPage ? 'pointer-events-none' : ''}`}
          aria-label="Previous page"
        >
          {prevPage && (
            <span class="text-4xl text-wisteria/50">←</span>
          )}
        </a>
        <a
          href={nextPage ? `/webcomic/${nextPage.slug}` : '#'}
          class={`absolute right-0 top-0 bottom-0 w-1/3 flex items-center justify-end pr-4 opacity-0 hover:opacity-100 transition-opacity ${!nextPage ? 'pointer-events-none' : ''}`}
          aria-label="Next page"
        >
          {nextPage && (
            <span class="text-4xl text-wisteria/50">→</span>
          )}
        </a>
      </div>

      <!-- Navigation -->
      <nav class="flex items-center justify-between max-w-2xl mx-auto mb-12">
        <div class="w-24">
          {prevPage && (
            <Button href={`/webcomic/${prevPage.slug}`} variant="ghost" size="sm">
              ← Prev
            </Button>
          )}
        </div>

        <div class="text-center">
          <p class="text-sm text-text-muted">
            {currentIndex} / {totalPages}
          </p>
          <Button href="/webcomic" variant="ghost" size="sm">
            All Pages
          </Button>
        </div>

        <div class="w-24 text-right">
          {nextPage && (
            <Button href={`/webcomic/${nextPage.slug}`} variant="ghost" size="sm">
              Next →
            </Button>
          )}
        </div>
      </nav>

      <!-- Transcript (for accessibility) -->
      {page.data.transcript && (
        <details class="max-w-2xl mx-auto mb-8">
          <summary class="text-sm text-text-muted cursor-pointer hover:text-text-secondary transition-colors">
            View transcript
          </summary>
          <div class="mt-4 p-4 bg-surface/50 rounded-lg border border-wisteria/10">
            <p class="text-text-secondary text-sm leading-relaxed">
              {page.data.transcript}
            </p>
          </div>
        </details>
      )}

      <!-- Author notes -->
      {page.body && (
        <div class="max-w-2xl mx-auto prose-comic">
          <Content />
        </div>
      )}
    </div>
  </article>
</Layout>

<style>
  .comic-container {
    cursor: default;
  }
</style>

<style is:global>
  .prose-comic {
    color: var(--color-text-muted);
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-style: italic;
    line-height: 1.6;
    text-align: center;
  }

  .prose-comic p {
    margin-bottom: 1rem;
  }
</style>
