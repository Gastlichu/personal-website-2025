---
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image, getImage } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import Badge from '../../components/ui/Badge.astro';
import Button from '../../components/ui/Button.astro';

export async function getStaticPaths() {
  const photos = await getCollection('photos');
  return photos.map((photo) => ({
    params: { slug: photo.slug },
    props: { photo },
  }));
}

interface Props {
  photo: CollectionEntry<'photos'>;
}

const { photo } = Astro.props;
const { Content } = await photo.render();

// Check if this is an album (has multiple images)
const isAlbum = photo.data.images && photo.data.images.length > 0;
const imageCount = isAlbum ? photo.data.images!.length : (photo.data.image ? 1 : 0);

// Generate optimized URLs for lightbox (larger size for carousel)
let lightboxImages: { src: string; width: number; height: number }[] = [];
if (isAlbum && photo.data.images) {
  lightboxImages = await Promise.all(
    photo.data.images.map(async (img) => {
      const optimized = await getImage({ src: img, width: 1600, format: 'webp' });
      return { src: optimized.src, width: optimized.attributes.width as number, height: optimized.attributes.height as number };
    })
  );
}

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<Layout
  title={`${photo.data.title} | Photos | Cosmic Ocean`}
  description={photo.data.description || `${photo.data.title} — Photography by José Angel`}
  room="photos"
>
  <article class="min-h-screen px-6 py-24">
    <div class={isAlbum ? "max-w-6xl mx-auto" : "max-w-5xl mx-auto"}>
      <!-- Back link -->
      <nav class="mb-8">
        <Button href="/photos" variant="ghost" size="sm">
          ← Back to Photos
        </Button>
      </nav>

      {isAlbum ? (
        <!-- ==================== ALBUM VIEW ==================== -->
        <Fragment>
          <!-- Album Header -->
          <header class="mb-12 text-center text-readable">
            <h1 class="text-3xl md:text-4xl font-display font-light text-text-primary mb-4">
              <span class="glow-photo">{photo.data.title}</span>
            </h1>
            {photo.data.description && (
              <p class="text-lg text-text-secondary leading-relaxed max-w-2xl mx-auto mb-4">
                {photo.data.description}
              </p>
            )}
            <p class="text-text-muted text-sm">
              {imageCount} photos · {photo.data.location} · {formatDate(photo.data.date)}
            </p>
            <p class="text-text-muted text-xs mt-2">Click any photo to view in carousel</p>
          </header>

          <!-- Album Gallery Grid -->
          <div id="album-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-12 stagger-children">
            {photo.data.images!.map((img, index) => (
              <button
                type="button"
                class="album-image group relative rounded-lg overflow-hidden bg-surface border border-ember/20 hover:border-ember/50 transition-all duration-300 cursor-pointer text-left"
                data-index={index}
                aria-label={`View photo ${index + 1} of ${imageCount}`}
              >
                <Image
                  src={img}
                  alt={`${photo.data.title} - Photo ${index + 1}`}
                  width={600}
                  height={450}
                  class="w-full h-auto aspect-[4/3] object-cover group-hover:scale-105 transition-transform duration-500"
                  loading={index < 6 ? "eager" : "lazy"}
                />
                <div class="absolute inset-0 bg-gradient-to-t from-void/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                <span class="absolute bottom-2 right-2 text-xs text-text-muted/60 opacity-0 group-hover:opacity-100 transition-opacity">{index + 1}/{imageCount}</span>
              </button>
            ))}
          </div>

          <!-- Lightbox Carousel -->
          <div
            id="lightbox"
            class="lightbox fixed inset-0 z-[100] bg-void/98 opacity-0 pointer-events-none transition-opacity duration-300"
            role="dialog"
            aria-modal="true"
            aria-label="Photo carousel"
          >
            <!-- Close button -->
            <button
              id="lightbox-close"
              class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
              aria-label="Close carousel"
            >
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>

            <!-- Counter -->
            <div id="lightbox-counter" class="absolute top-4 left-4 text-text-muted text-sm font-mono">
              1 / {imageCount}
            </div>

            <!-- Navigation arrows -->
            <button
              id="lightbox-prev"
              class="absolute left-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
              aria-label="Previous photo"
            >
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" />
              </svg>
            </button>

            <button
              id="lightbox-next"
              class="absolute right-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
              aria-label="Next photo"
            >
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6" />
              </svg>
            </button>

            <!-- Image container - fills viewport with smart cropping -->
            <div id="lightbox-image-container" class="absolute inset-x-0 top-16 bottom-16 sm:inset-16 flex items-center justify-center">
              <img
                id="lightbox-image"
                src=""
                alt=""
                class="w-full h-full object-cover rounded-lg cursor-zoom-in transition-transform duration-300"
              />
            </div>

            <!-- Hint -->
            <p class="absolute bottom-4 left-1/2 -translate-x-1/2 text-text-muted text-xs text-center px-4">
              <span class="hidden sm:inline">Use arrow keys to navigate · Click image for full uncropped view · Esc to close</span>
              <span class="sm:hidden">Swipe to navigate · Tap image for full view</span>
            </p>
          </div>

          <!-- Full Image Overlay (for viewing original size with zoom) -->
          <div
            id="fullsize-overlay"
            class="fullsize-overlay fixed inset-0 z-[200] bg-void/99 opacity-0 pointer-events-none transition-opacity duration-300"
            role="dialog"
            aria-modal="true"
            aria-label="Full size image with zoom control"
          >
            <!-- Close button -->
            <button
              id="fullsize-close"
              class="fixed top-4 right-4 z-10 w-12 h-12 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
              aria-label="Close full size view"
            >
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
              </svg>
            </button>

            <!-- Image container with scroll -->
            <div id="fullsize-scroll-container" class="absolute inset-0 top-0 bottom-20 overflow-auto">
              <div id="fullsize-image-wrapper" class="min-h-full flex items-center justify-center p-4">
                <img
                  id="fullsize-image"
                  src=""
                  alt=""
                  class="max-w-none transition-transform duration-200 origin-center"
                  style="transform: scale(1);"
                />
              </div>
            </div>

            <!-- Zoom Controls -->
            <div class="fixed bottom-0 inset-x-0 z-10 bg-gradient-to-t from-void via-void/90 to-transparent pt-8 pb-4 px-6">
              <div class="max-w-md mx-auto">
                <!-- Zoom slider -->
                <div class="flex items-center gap-4">
                  <button
                    id="zoom-out-btn"
                    class="w-10 h-10 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
                    aria-label="Zoom out"
                  >
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <path d="M21 21l-4.35-4.35M8 11h6" />
                    </svg>
                  </button>

                  <div class="flex-1 flex flex-col gap-1">
                    <input
                      type="range"
                      id="zoom-slider"
                      min="50"
                      max="300"
                      value="100"
                      step="10"
                      class="zoom-slider w-full h-2 bg-surface/50 rounded-full appearance-none cursor-pointer"
                      aria-label="Zoom level"
                    />
                    <div class="flex justify-between text-xs text-text-muted">
                      <span>50%</span>
                      <span id="zoom-level" class="text-text-secondary font-mono">100%</span>
                      <span>300%</span>
                    </div>
                  </div>

                  <button
                    id="zoom-in-btn"
                    class="w-10 h-10 rounded-full bg-surface/80 border border-ember/30 flex items-center justify-center text-text-primary hover:bg-surface hover:border-ember transition-all"
                    aria-label="Zoom in"
                  >
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <path d="M21 21l-4.35-4.35M11 8v6M8 11h6" />
                    </svg>
                  </button>
                </div>

                <!-- Hint -->
                <p class="text-center text-text-muted text-xs mt-3">
                  <span class="hidden sm:inline">Scroll to pan when zoomed · Press Esc to close</span>
                  <span class="sm:hidden">Drag to pan when zoomed · Tap X to close</span>
                </p>
              </div>
            </div>
          </div>

          <!-- Store image data for JS -->
          <script id="lightbox-data" type="application/json" set:html={JSON.stringify(lightboxImages)}></script>

          <!-- Album Footer Info -->
          <div class="max-w-2xl mx-auto text-readable">
            <!-- Tags -->
            {photo.data.tags.length > 0 && (
              <div class="flex flex-wrap justify-center gap-2 mb-8">
                {photo.data.tags.filter(tag => tag !== 'album').map((tag) => (
                  <Badge variant="outline">{tag}</Badge>
                ))}
              </div>
            )}

            <!-- Content (photographer notes) -->
            {photo.body && (
              <div class="prose-photo mb-12 text-center">
                <Content />
              </div>
            )}

            <!-- Footer -->
            <footer class="pt-8 border-t border-ember/20 text-center">
              <Button href="/photos" variant="secondary">
                ← All Photos
              </Button>
            </footer>
          </div>
        </Fragment>
      ) : (
        <!-- ==================== SINGLE PHOTO VIEW ==================== -->
        <Fragment>
          <!-- Photo Display -->
          <div class="mb-12">
            <div class="rounded-lg bg-surface border border-ember/20 overflow-hidden">
              {photo.data.image ? (
                <Image
                  src={photo.data.image}
                  alt={photo.data.title}
                  width={1400}
                  height={933}
                  class="w-full h-auto"
                  loading="eager"
                />
              ) : (
                <div class="aspect-[3/2] flex items-center justify-center">
                  <span class="text-8xl text-ember/30 font-display font-light select-none">❋</span>
                </div>
              )}
            </div>
          </div>

          <!-- Info -->
          <div class="max-w-2xl mx-auto text-readable">
            <header class="mb-8">
              <h1 class="text-3xl md:text-4xl font-display font-light text-text-primary mb-4">
                <span class="glow-photo">{photo.data.title}</span>
              </h1>

              {photo.data.description && (
                <p class="text-lg text-text-secondary leading-relaxed">
                  {photo.data.description}
                </p>
              )}
            </header>

            <!-- Metadata -->
            <dl class="grid grid-cols-2 gap-4 mb-8 p-6 bg-surface/30 rounded-lg border border-ember/10">
              <div>
                <dt class="text-sm text-text-muted">Date</dt>
                <dd class="text-text-secondary">{formatDate(photo.data.date)}</dd>
              </div>
              {photo.data.location && (
                <div>
                  <dt class="text-sm text-text-muted">Location</dt>
                  <dd class="text-text-secondary">{photo.data.location}</dd>
                </div>
              )}
              {photo.data.camera && (
                <div>
                  <dt class="text-sm text-text-muted">Camera</dt>
                  <dd class="text-text-secondary">{photo.data.camera}</dd>
                </div>
              )}
            </dl>

            <!-- Tags -->
            {photo.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-8">
                {photo.data.tags.map((tag) => (
                  <Badge variant="outline">{tag}</Badge>
                ))}
              </div>
            )}

            <!-- Content (photographer notes) -->
            {photo.body && (
              <div class="prose-photo mb-12">
                <Content />
              </div>
            )}

            <!-- Footer -->
            <footer class="pt-8 border-t border-ember/20">
              <Button href="/photos" variant="secondary">
                ← All Photos
              </Button>
            </footer>
          </div>
        </Fragment>
      )}
    </div>
  </article>
</Layout>

{isAlbum && (
  <script>
    // Lightbox carousel functionality
    document.addEventListener('DOMContentLoaded', initLightbox);
    document.addEventListener('astro:page-load', initLightbox);

    function initLightbox() {
      const dataEl = document.getElementById('lightbox-data');
      if (!dataEl) return;

      const images: { src: string; width: number; height: number }[] = JSON.parse(dataEl.textContent || '[]');
      if (images.length === 0) return;

      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
      const lightboxCounter = document.getElementById('lightbox-counter');
      const closeBtn = document.getElementById('lightbox-close');
      const prevBtn = document.getElementById('lightbox-prev');
      const nextBtn = document.getElementById('lightbox-next');
      const albumGrid = document.getElementById('album-grid');
      const fullsizeOverlay = document.getElementById('fullsize-overlay');
      const fullsizeImage = document.getElementById('fullsize-image') as HTMLImageElement;
      const fullsizeClose = document.getElementById('fullsize-close');
      const fullsizeScrollContainer = document.getElementById('fullsize-scroll-container');
      const zoomSlider = document.getElementById('zoom-slider') as HTMLInputElement;
      const zoomLevel = document.getElementById('zoom-level');
      const zoomInBtn = document.getElementById('zoom-in-btn');
      const zoomOutBtn = document.getElementById('zoom-out-btn');

      if (!lightbox || !lightboxImage || !albumGrid) return;

      let currentIndex = 0;
      let touchStartX = 0;
      let touchEndX = 0;
      let currentZoom = 100;

      // Open lightbox
      function openLightbox(index: number) {
        currentIndex = index;
        updateImage();
        lightbox.classList.remove('opacity-0', 'pointer-events-none');
        lightbox.classList.add('opacity-100', 'pointer-events-auto');
        document.body.style.overflow = 'hidden';
      }

      // Close lightbox
      function closeLightbox() {
        lightbox.classList.add('opacity-0', 'pointer-events-none');
        lightbox.classList.remove('opacity-100', 'pointer-events-auto');
        document.body.style.overflow = '';
      }

      // Update displayed image
      function updateImage() {
        const img = images[currentIndex];
        lightboxImage.src = img.src;
        lightboxImage.alt = `Photo ${currentIndex + 1}`;
        if (lightboxCounter) {
          lightboxCounter.textContent = `${currentIndex + 1} / ${images.length}`;
        }
      }

      // Navigate
      function goToNext() {
        currentIndex = (currentIndex + 1) % images.length;
        updateImage();
      }

      function goToPrev() {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        updateImage();
      }

      // Zoom functionality
      function setZoom(value: number) {
        currentZoom = Math.max(50, Math.min(300, value));
        if (fullsizeImage) {
          fullsizeImage.style.transform = `scale(${currentZoom / 100})`;
        }
        if (zoomSlider) {
          zoomSlider.value = String(currentZoom);
        }
        if (zoomLevel) {
          zoomLevel.textContent = `${currentZoom}%`;
        }
      }

      function resetZoom() {
        setZoom(100);
        // Reset scroll position
        if (fullsizeScrollContainer) {
          fullsizeScrollContainer.scrollTop = 0;
          fullsizeScrollContainer.scrollLeft = 0;
        }
      }

      // Full size view
      function openFullSize() {
        if (!fullsizeOverlay || !fullsizeImage) return;
        fullsizeImage.src = images[currentIndex].src;
        resetZoom();
        fullsizeOverlay.classList.remove('opacity-0', 'pointer-events-none');
        fullsizeOverlay.classList.add('opacity-100', 'pointer-events-auto');
      }

      function closeFullSize() {
        if (!fullsizeOverlay) return;
        fullsizeOverlay.classList.add('opacity-0', 'pointer-events-none');
        fullsizeOverlay.classList.remove('opacity-100', 'pointer-events-auto');
        resetZoom();
      }

      // Zoom event listeners
      zoomSlider?.addEventListener('input', () => {
        setZoom(parseInt(zoomSlider.value, 10));
      });

      zoomInBtn?.addEventListener('click', () => {
        setZoom(currentZoom + 25);
      });

      zoomOutBtn?.addEventListener('click', () => {
        setZoom(currentZoom - 25);
      });

      // Event listeners - Grid images
      albumGrid.querySelectorAll('.album-image').forEach((btn) => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.getAttribute('data-index') || '0', 10);
          openLightbox(index);
        });
      });

      // Close button
      closeBtn?.addEventListener('click', closeLightbox);

      // Navigation buttons
      prevBtn?.addEventListener('click', goToPrev);
      nextBtn?.addEventListener('click', goToNext);

      // Click on image for full size
      lightboxImage.addEventListener('click', openFullSize);

      // Close full size (only via X button or Escape - not by clicking image since user may want to pan)
      fullsizeClose?.addEventListener('click', closeFullSize);

      // Close when clicking the scroll container background (not the image)
      fullsizeScrollContainer?.addEventListener('click', (e) => {
        // Only close if clicking directly on the scroll container or image wrapper (not the image itself)
        const target = e.target as HTMLElement;
        if (target.id === 'fullsize-scroll-container' || target.id === 'fullsize-image-wrapper') {
          closeFullSize();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('opacity-100')) return;

        // If full size is open, only handle escape
        if (fullsizeOverlay?.classList.contains('opacity-100')) {
          if (e.key === 'Escape') {
            closeFullSize();
          }
          return;
        }

        switch (e.key) {
          case 'ArrowLeft':
            goToPrev();
            break;
          case 'ArrowRight':
            goToNext();
            break;
          case 'Escape':
            closeLightbox();
            break;
        }
      });

      // Touch/swipe support
      lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      lightbox.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            goToNext(); // Swipe left = next
          } else {
            goToPrev(); // Swipe right = prev
          }
        }
      }

      // Click outside image to close
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox || (e.target as HTMLElement).id === 'lightbox-image-container') {
          closeLightbox();
        }
      });
    }
  </script>
)}

<style>
  .glow-photo {
    text-shadow:
      0 0 20px var(--color-ember),
      0 0 40px var(--color-spark);
  }

  .album-image {
    contain: layout;
  }

  /* Lightbox styles */
  .lightbox.opacity-100 {
    opacity: 1;
    pointer-events: auto;
  }

  .fullsize-overlay.opacity-100 {
    opacity: 1;
    pointer-events: auto;
  }

  /* Prevent body scroll when lightbox is open */
  :global(body.lightbox-open) {
    overflow: hidden;
  }

  /* Zoom slider styling */
  .zoom-slider {
    -webkit-appearance: none;
    appearance: none;
    background: rgba(30, 30, 45, 0.6);
    border-radius: 9999px;
    height: 8px;
  }

  .zoom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-ember), var(--color-spark));
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(212, 165, 116, 0.4);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .zoom-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 0 15px rgba(212, 165, 116, 0.6);
  }

  .zoom-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-ember), var(--color-spark));
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(212, 165, 116, 0.4);
  }

  .zoom-slider::-moz-range-track {
    background: rgba(30, 30, 45, 0.6);
    border-radius: 9999px;
    height: 8px;
  }

  /* Fullsize overlay scroll container */
  #fullsize-scroll-container {
    scrollbar-width: thin;
    scrollbar-color: rgba(212, 165, 116, 0.4) transparent;
  }

  #fullsize-scroll-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  #fullsize-scroll-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #fullsize-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(212, 165, 116, 0.4);
    border-radius: 4px;
  }

  #fullsize-scroll-container::-webkit-scrollbar-thumb:hover {
    background: rgba(212, 165, 116, 0.6);
  }
</style>

<style is:global>
  .prose-photo {
    color: var(--color-text-secondary);
    font-family: var(--font-body);
    line-height: 1.7;
  }

  .prose-photo p {
    margin-bottom: 1.25rem;
  }
</style>
