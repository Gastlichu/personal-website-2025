---
import { ViewTransitions, fade } from 'astro:transitions'
import '../styles/global.css'
import ParticleField from '../components/ParticleField.astro'
import Navigation from '../components/Navigation.astro'

export type RoomVibe = 'home' | 'blog' | 'gallery' | 'about' | 'styleguide' | 'games' | 'webcomic' | 'photos' | 'links';

interface Props {
  title: string;
  description?: string;
  image?: string;
  room?: RoomVibe;
  article?: boolean;
}

const {
  title,
  description = "Creative developer and digital artist exploring the liminal space where deep ocean meets outer space.",
  image = "/og-image.png",
  room = 'home',
  article = false,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.site);

// Room-specific color configurations
const roomColors: Record<RoomVibe, { blob1: string; blob2: string; blob3: string }> = {
  home: { blob1: 'bg-nebula', blob2: 'bg-orchid', blob3: 'bg-abyss' },
  blog: { blob1: 'bg-abyss', blob2: 'bg-nebula', blob3: 'bg-orchid' },      // Deeper, more purple
  gallery: { blob1: 'bg-nebula', blob2: 'bg-coral', blob3: 'bg-abyss' },    // Warmer coral accent
  about: { blob1: 'bg-abyss', blob2: 'bg-bloom', blob3: 'bg-nebula' },      // Soft glow
  styleguide: { blob1: 'bg-wisteria', blob2: 'bg-orchid', blob3: 'bg-nebula' }, // Bright, reference
  games: { blob1: 'bg-aurora', blob2: 'bg-bloom', blob3: 'bg-abyss' },      // Playful aurora glow
  webcomic: { blob1: 'bg-wisteria', blob2: 'bg-abyss', blob3: 'bg-orchid' }, // Dreamy, narrative
  photos: { blob1: 'bg-ember', blob2: 'bg-spark', blob3: 'bg-deep' },       // Warm, amber tones
  links: { blob1: 'bg-coral', blob2: 'bg-spark', blob3: 'bg-nebula' },      // Warm, inviting
};

const colors = roomColors[room];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#0a0a14" id="theme-color" />

    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      (function() {
        // Default to cosmic (dark) - only use twilight if user explicitly chose it
        const saved = localStorage.getItem('theme');
        if (saved === 'twilight') {
          document.documentElement.setAttribute('data-theme', 'twilight');
          document.getElementById('theme-color')?.setAttribute('content', '#e8e4f0');
        }
      })();
    </script>

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content="José Angel (Gastlichu)" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:site_name" content="Cosmic Ocean" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Cosmic Ocean Blog" href="/rss.xml" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Outfit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <ViewTransitions />
  </head>
  <body class="bg-void text-text-primary min-h-screen font-body overflow-x-hidden">
    <!-- Breathing Background (Layer 1) -->
    <div id="breathing-bg" class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true" transition:persist="bg">
      <div id="blob-1" class:list={["breathing-blob blob-1 absolute w-[600px] h-[600px] rounded-full opacity-45 blur-[100px] transition-colors duration-300", colors.blob1]}></div>
      <div id="blob-2" class:list={["breathing-blob blob-2 absolute w-[500px] h-[500px] rounded-full opacity-40 blur-[80px] transition-colors duration-300", colors.blob2]}></div>
      <div id="blob-3" class:list={["breathing-blob blob-3 absolute w-[700px] h-[700px] rounded-full opacity-50 blur-[90px] transition-colors duration-300", colors.blob3]}></div>
    </div>

    <!-- Particle Field (Layer 2 + Reactive Layer 3) -->
    <ParticleField />

    <!-- Navigation -->
    <Navigation />

    <!-- Under Construction Banner -->
    <div class="fixed top-0 inset-x-0 z-40 bg-surface/80 backdrop-blur-sm border-b border-orchid/20 py-2 px-4 text-center" transition:persist="banner">
      <p class="text-sm text-text-muted font-body">
        <span class="text-orchid">Under construction</span> — Content is placeholder text while the site takes shape
      </p>
    </div>

    <!-- Subtle Transition Overlay (only shows for slow loads) -->
    <div id="transition-overlay" class="transition-overlay" aria-hidden="true" transition:persist="overlay">
      <div class="overlay-glow"></div>
    </div>

    <!-- Content -->
    <main class="relative z-10 pt-10" transition:animate={fade({ duration: '150ms' })}>
      <slot />
    </main>

    <script is:inline>
      // Subtle transition overlay - only shows for slow transitions
      (function() {
        const overlay = document.getElementById('transition-overlay');
        if (!overlay || overlay.dataset.initialized) return;
        overlay.dataset.initialized = 'true';

        let showTimer = null;
        const SHOW_DELAY = 30; // Show overlay quickly for consistent transition feel

        // Start timer when navigation begins
        document.addEventListener('astro:before-preparation', () => {
          // Clear any existing timer
          if (showTimer) clearTimeout(showTimer);

          // Only show overlay if loading takes longer than threshold
          showTimer = setTimeout(() => {
            overlay.classList.add('is-active');
          }, SHOW_DELAY);
        });

        // Hide overlay and cancel timer when content is ready
        document.addEventListener('astro:after-swap', () => {
          if (showTimer) {
            clearTimeout(showTimer);
            showTimer = null;
          }
          overlay.classList.remove('is-active');
        });

        // Also hide on page load (for initial load and fallback)
        document.addEventListener('astro:page-load', () => {
          if (showTimer) {
            clearTimeout(showTimer);
            showTimer = null;
          }
          overlay.classList.remove('is-active');
        });
      })();
    </script>

    <script is:inline>
      // Room color updater - syncs blob colors after View Transitions
      (function() {
        if (window.__roomColorInitialized) return;
        window.__roomColorInitialized = true;

        // Room-specific color configurations (mirrors server-side roomColors)
        const roomColors = {
          home: { blob1: 'bg-nebula', blob2: 'bg-orchid', blob3: 'bg-abyss' },
          blog: { blob1: 'bg-abyss', blob2: 'bg-nebula', blob3: 'bg-orchid' },
          gallery: { blob1: 'bg-nebula', blob2: 'bg-coral', blob3: 'bg-abyss' },
          about: { blob1: 'bg-abyss', blob2: 'bg-bloom', blob3: 'bg-nebula' },
          styleguide: { blob1: 'bg-wisteria', blob2: 'bg-orchid', blob3: 'bg-nebula' },
          games: { blob1: 'bg-aurora', blob2: 'bg-bloom', blob3: 'bg-abyss' },
          webcomic: { blob1: 'bg-wisteria', blob2: 'bg-abyss', blob3: 'bg-orchid' },
          photos: { blob1: 'bg-ember', blob2: 'bg-spark', blob3: 'bg-deep' },
          links: { blob1: 'bg-coral', blob2: 'bg-spark', blob3: 'bg-nebula' },
        };

        // All possible color classes (for removal)
        const allColorClasses = [
          'bg-nebula', 'bg-orchid', 'bg-abyss', 'bg-coral', 'bg-bloom',
          'bg-wisteria', 'bg-aurora', 'bg-ember', 'bg-spark', 'bg-deep'
        ];

        function getRoomFromPath(path) {
          // Extract base room from path
          const segments = path.split('/').filter(Boolean);
          if (segments.length === 0) return 'home';

          const baseRoom = segments[0];
          // Map URL segments to room names
          const roomMap = {
            'blog': 'blog',
            'gallery': 'gallery',
            'about': 'about',
            'style-guide': 'styleguide',
            'games': 'games',
            'webcomic': 'webcomic',
            'photos': 'photos',
            'links': 'links',
          };
          return roomMap[baseRoom] || 'home';
        }

        function updateBlobColors() {
          const room = getRoomFromPath(window.location.pathname);
          const colors = roomColors[room] || roomColors.home;

          const blob1 = document.getElementById('blob-1');
          const blob2 = document.getElementById('blob-2');
          const blob3 = document.getElementById('blob-3');

          if (!blob1 || !blob2 || !blob3) return;

          // Remove all color classes, then add the new ones
          [blob1, blob2, blob3].forEach(blob => {
            allColorClasses.forEach(cls => blob.classList.remove(cls));
          });

          blob1.classList.add(colors.blob1);
          blob2.classList.add(colors.blob2);
          blob3.classList.add(colors.blob3);
        }

        // Update colors after View Transition swap
        document.addEventListener('astro:after-swap', updateBlobColors);

        // Also run on initial page load (in case of direct navigation)
        document.addEventListener('astro:page-load', updateBlobColors);
      })();
    </script>
  </body>
</html>

<style>
  .breathing-blob {
    will-change: transform;
  }

  .blob-1 {
    top: -10%;
    left: -5%;
    animation: drift-1 25s ease-in-out infinite;
  }

  .blob-2 {
    top: 40%;
    right: -10%;
    animation: drift-2 30s ease-in-out infinite;
  }

  .blob-3 {
    bottom: -20%;
    left: 30%;
    animation: drift-3 22s ease-in-out infinite;
  }

  @keyframes drift-1 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(10%, 15%) scale(1.05);
    }
    50% {
      transform: translate(5%, 25%) scale(0.95);
    }
    75% {
      transform: translate(-5%, 10%) scale(1.02);
    }
  }

  @keyframes drift-2 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(-15%, -10%) scale(1.08);
    }
    66% {
      transform: translate(-10%, 15%) scale(0.92);
    }
  }

  @keyframes drift-3 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    20% {
      transform: translate(15%, -10%) scale(1.03);
    }
    40% {
      transform: translate(25%, 5%) scale(0.97);
    }
    60% {
      transform: translate(10%, 15%) scale(1.05);
    }
    80% {
      transform: translate(-5%, 5%) scale(0.98);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .breathing-blob {
      animation: none;
    }
  }

  /* Subtle Transition Overlay - only appears for slow loads */
  /* Note: backdrop-filter removed for performance */
  .transition-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease-out;
    background: rgba(10, 10, 20, 0.6);
  }

  .transition-overlay.is-active {
    opacity: 1;
  }

  .overlay-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(208, 120, 200, 0.15) 0%,
      rgba(144, 72, 160, 0.08) 40%,
      transparent 70%
    );
    animation: soft-pulse 1.5s ease-in-out infinite;
  }

  @keyframes soft-pulse {
    0%, 100% {
      opacity: 0.6;
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.15);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .overlay-glow {
      animation: none;
    }
    .transition-overlay {
      transition: opacity 0.1s;
    }
  }
</style>
