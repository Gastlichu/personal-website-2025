---
import { ViewTransitions } from 'astro:transitions'
import '../styles/global.css'
import ParticleField from '../components/ParticleField.astro'
import Navigation from '../components/Navigation.astro'

export type RoomVibe = 'home' | 'blog' | 'gallery' | 'about' | 'styleguide' | 'games' | 'webcomic' | 'photos' | 'links';

// Custom "emerge" transition - content rises from the void
const emergeTransition = {
  forwards: {
    old: {
      name: 'emerge-out',
      duration: '200ms',
      easing: 'cubic-bezier(0.4, 0, 0.6, 1)',
      fillMode: 'forwards',
    },
    new: {
      name: 'emerge-in',
      duration: '300ms',
      easing: 'cubic-bezier(0, 0, 0.2, 1)',
      fillMode: 'backwards',
    },
  },
  backwards: {
    old: {
      name: 'emerge-out',
      duration: '200ms',
      easing: 'cubic-bezier(0.4, 0, 0.6, 1)',
      fillMode: 'forwards',
    },
    new: {
      name: 'emerge-in',
      duration: '300ms',
      easing: 'cubic-bezier(0, 0, 0.2, 1)',
      fillMode: 'backwards',
    },
  },
};

interface Props {
  title: string;
  description?: string;
  image?: string;
  room?: RoomVibe;
  article?: boolean;
}

const {
  title,
  description = "Creative developer and digital artist exploring the liminal space where deep ocean meets outer space.",
  image = "/og-image.png",
  room = 'home',
  article = false,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.site);

// Room-specific color configurations
const roomColors: Record<RoomVibe, { blob1: string; blob2: string; blob3: string }> = {
  home: { blob1: 'bg-nebula', blob2: 'bg-orchid', blob3: 'bg-abyss' },
  blog: { blob1: 'bg-abyss', blob2: 'bg-nebula', blob3: 'bg-orchid' },      // Deeper, more purple
  gallery: { blob1: 'bg-nebula', blob2: 'bg-coral', blob3: 'bg-abyss' },    // Warmer coral accent
  about: { blob1: 'bg-abyss', blob2: 'bg-bloom', blob3: 'bg-nebula' },      // Soft glow
  styleguide: { blob1: 'bg-wisteria', blob2: 'bg-orchid', blob3: 'bg-nebula' }, // Bright, reference
  games: { blob1: 'bg-aurora', blob2: 'bg-bloom', blob3: 'bg-abyss' },      // Playful aurora glow
  webcomic: { blob1: 'bg-wisteria', blob2: 'bg-abyss', blob3: 'bg-orchid' }, // Dreamy, narrative
  photos: { blob1: 'bg-ember', blob2: 'bg-spark', blob3: 'bg-deep' },       // Warm, amber tones
  links: { blob1: 'bg-coral', blob2: 'bg-spark', blob3: 'bg-nebula' },      // Warm, inviting
};

const colors = roomColors[room];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#0a0a14" id="theme-color" />

    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      (function() {
        // Default to cosmic (dark) - only use twilight if user explicitly chose it
        const saved = localStorage.getItem('theme');
        if (saved === 'twilight') {
          document.documentElement.setAttribute('data-theme', 'twilight');
          document.getElementById('theme-color')?.setAttribute('content', '#e8e4f0');
        }
      })();
    </script>

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content="José Angel (Gastlichu)" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:site_name" content="Cosmic Ocean" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Cosmic Ocean Blog" href="/rss.xml" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Outfit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <ViewTransitions />
  </head>
  <body class="bg-void text-text-primary font-body">
    <!-- Breathing Background (Layer 1) -->
    <div id="breathing-bg" class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true" transition:persist="bg">
      <div id="blob-1" class:list={["breathing-blob blob-1 absolute w-[600px] h-[600px] rounded-full opacity-45 blur-[100px] transition-colors duration-300", colors.blob1]}></div>
      <div id="blob-2" class:list={["breathing-blob blob-2 absolute w-[500px] h-[500px] rounded-full opacity-40 blur-[80px] transition-colors duration-300", colors.blob2]}></div>
      <div id="blob-3" class:list={["breathing-blob blob-3 absolute w-[700px] h-[700px] rounded-full opacity-50 blur-[90px] transition-colors duration-300", colors.blob3]}></div>
    </div>

    <!-- Particle Field (Layer 2 + Reactive Layer 3) -->
    <ParticleField />

    <!-- Navigation -->
    <Navigation />

    <!-- Subtle Transition Overlay (only shows for slow loads) -->
    <div id="transition-overlay" class="transition-overlay" aria-hidden="true" transition:persist="overlay">
      <div class="overlay-glow glow-1"></div>
      <div class="overlay-glow glow-2"></div>
      <div class="overlay-glow glow-3"></div>
    </div>

    <!-- Content -->
    <main class="relative page-content" transition:animate={emergeTransition}>
      <slot />
    </main>

    <!-- Scroll-Reveal Signature -->
    <footer id="signature" class="signature fixed bottom-6 left-1/2 -translate-x-1/2 z-30 opacity-0 transition-opacity duration-500 pointer-events-none">
      <p class="text-text-muted text-sm font-body tracking-wide">
        © 2025 José Angel
      </p>
    </footer>

    <script is:inline>
      // Subtle transition overlay - only shows for slow transitions
      (function() {
        const overlay = document.getElementById('transition-overlay');
        if (!overlay || overlay.dataset.initialized) return;
        overlay.dataset.initialized = 'true';

        let showTimer = null;
        const SHOW_DELAY = 30; // Show overlay quickly for consistent transition feel

        // Start timer when navigation begins
        document.addEventListener('astro:before-preparation', () => {
          // Clear any existing timer
          if (showTimer) clearTimeout(showTimer);

          // Only show overlay if loading takes longer than threshold
          showTimer = setTimeout(() => {
            overlay.classList.add('is-active');
          }, SHOW_DELAY);
        });

        // Hide overlay and cancel timer when content is ready
        document.addEventListener('astro:after-swap', () => {
          if (showTimer) {
            clearTimeout(showTimer);
            showTimer = null;
          }
          overlay.classList.remove('is-active');
        });

        // Also hide on page load (for initial load and fallback)
        document.addEventListener('astro:page-load', () => {
          if (showTimer) {
            clearTimeout(showTimer);
            showTimer = null;
          }
          overlay.classList.remove('is-active');
        });
      })();
    </script>

    <script is:inline>
      // Room color updater - syncs blob colors after View Transitions
      (function() {
        if (window.__roomColorInitialized) return;
        window.__roomColorInitialized = true;

        // Room-specific color configurations (mirrors server-side roomColors)
        const roomColors = {
          home: { blob1: 'bg-nebula', blob2: 'bg-orchid', blob3: 'bg-abyss' },
          blog: { blob1: 'bg-abyss', blob2: 'bg-nebula', blob3: 'bg-orchid' },
          gallery: { blob1: 'bg-nebula', blob2: 'bg-coral', blob3: 'bg-abyss' },
          about: { blob1: 'bg-abyss', blob2: 'bg-bloom', blob3: 'bg-nebula' },
          styleguide: { blob1: 'bg-wisteria', blob2: 'bg-orchid', blob3: 'bg-nebula' },
          games: { blob1: 'bg-aurora', blob2: 'bg-bloom', blob3: 'bg-abyss' },
          webcomic: { blob1: 'bg-wisteria', blob2: 'bg-abyss', blob3: 'bg-orchid' },
          photos: { blob1: 'bg-ember', blob2: 'bg-spark', blob3: 'bg-deep' },
          links: { blob1: 'bg-coral', blob2: 'bg-spark', blob3: 'bg-nebula' },
        };

        // All possible color classes (for removal)
        const allColorClasses = [
          'bg-nebula', 'bg-orchid', 'bg-abyss', 'bg-coral', 'bg-bloom',
          'bg-wisteria', 'bg-aurora', 'bg-ember', 'bg-spark', 'bg-deep'
        ];

        function getRoomFromPath(path) {
          // Extract base room from path
          const segments = path.split('/').filter(Boolean);
          if (segments.length === 0) return 'home';

          const baseRoom = segments[0];
          // Map URL segments to room names
          const roomMap = {
            'blog': 'blog',
            'gallery': 'gallery',
            'about': 'about',
            'style-guide': 'styleguide',
            'games': 'games',
            'webcomic': 'webcomic',
            'photos': 'photos',
            'links': 'links',
          };
          return roomMap[baseRoom] || 'home';
        }

        function updateBlobColors() {
          const room = getRoomFromPath(window.location.pathname);
          const colors = roomColors[room] || roomColors.home;

          const blob1 = document.getElementById('blob-1');
          const blob2 = document.getElementById('blob-2');
          const blob3 = document.getElementById('blob-3');

          if (!blob1 || !blob2 || !blob3) return;

          // Remove all color classes, then add the new ones
          [blob1, blob2, blob3].forEach(blob => {
            allColorClasses.forEach(cls => blob.classList.remove(cls));
          });

          blob1.classList.add(colors.blob1);
          blob2.classList.add(colors.blob2);
          blob3.classList.add(colors.blob3);
        }

        // Update colors after View Transition swap
        document.addEventListener('astro:after-swap', updateBlobColors);

        // Also run on initial page load (in case of direct navigation)
        document.addEventListener('astro:page-load', updateBlobColors);
      })();
    </script>

    <script is:inline>
      // Scroll-reveal signature - fades in when near bottom of page
      (function() {
        if (window.__signatureInitialized) return;
        window.__signatureInitialized = true;

        function initSignature() {
          const signature = document.getElementById('signature');
          const scrollContainer = document.body;
          if (!signature || !scrollContainer) return;

          let ticking = false;

          function checkScroll() {
            // Use body as scroll container (since html has overflow:hidden)
            const scrollHeight = scrollContainer.scrollHeight;
            const scrollTop = scrollContainer.scrollTop;
            const clientHeight = scrollContainer.clientHeight;

            // Calculate how close to bottom (0 = top, 1 = bottom)
            const maxScroll = scrollHeight - clientHeight;
            const scrollProgress = maxScroll > 0 ? scrollTop / maxScroll : 1;

            // Show signature when in bottom 15% of page, or if page is short
            if (scrollProgress > 0.85 || maxScroll <= 0) {
              signature.style.opacity = '1';
              signature.style.pointerEvents = 'auto';
            } else {
              signature.style.opacity = '0';
              signature.style.pointerEvents = 'none';
            }

            ticking = false;
          }

          function onScroll() {
            if (!ticking) {
              requestAnimationFrame(checkScroll);
              ticking = true;
            }
          }

          // Listen on body since it's the scroll container
          scrollContainer.addEventListener('scroll', onScroll, { passive: true });
          // Check initial state
          checkScroll();
        }

        initSignature();
        document.addEventListener('astro:page-load', initSignature);
      })();
    </script>
  </body>
</html>

<style>
  .breathing-blob {
    will-change: transform;
  }

  .blob-1 {
    top: -10%;
    left: -5%;
    animation: drift-1 25s ease-in-out infinite;
  }

  .blob-2 {
    top: 40%;
    right: -10%;
    animation: drift-2 30s ease-in-out infinite;
  }

  .blob-3 {
    bottom: -20%;
    left: 30%;
    animation: drift-3 22s ease-in-out infinite;
  }

  @keyframes drift-1 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(10%, 15%) scale(1.05);
    }
    50% {
      transform: translate(5%, 25%) scale(0.95);
    }
    75% {
      transform: translate(-5%, 10%) scale(1.02);
    }
  }

  @keyframes drift-2 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(-15%, -10%) scale(1.08);
    }
    66% {
      transform: translate(-10%, 15%) scale(0.92);
    }
  }

  @keyframes drift-3 {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    20% {
      transform: translate(15%, -10%) scale(1.03);
    }
    40% {
      transform: translate(25%, 5%) scale(0.97);
    }
    60% {
      transform: translate(10%, 15%) scale(1.05);
    }
    80% {
      transform: translate(-5%, 5%) scale(0.98);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .breathing-blob {
      animation: none;
    }
  }

  /* ============================================
     PAGE TRANSITION ANIMATIONS
     Content emerges from/sinks into the void
     ============================================ */

  /* Emerge In - new content rises and focuses */
  @keyframes emerge-in {
    from {
      opacity: 0;
      transform: translateY(8px) scale(0.98);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
  }

  /* Emerge Out - old content sinks and fades */
  @keyframes emerge-out {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
    to {
      opacity: 0;
      transform: translateY(-4px) scale(0.99);
      filter: blur(2px);
    }
  }

  /* ============================================
     TRANSITION OVERLAY
     Layered glow effect during navigation
     ============================================ */

  .transition-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: radial-gradient(
      ellipse at center,
      rgba(10, 10, 20, 0.4) 0%,
      rgba(10, 10, 20, 0.7) 100%
    );
  }

  .transition-overlay.is-active {
    opacity: 1;
  }

  /* Layered glow orbs for depth */
  .overlay-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    border-radius: 50%;
  }

  .overlay-glow.glow-1 {
    width: 300px;
    height: 300px;
    transform: translate(-50%, -50%);
    background: radial-gradient(
      circle,
      rgba(208, 120, 200, 0.12) 0%,
      transparent 70%
    );
    animation: glow-pulse-1 2s ease-in-out infinite;
  }

  .overlay-glow.glow-2 {
    width: 200px;
    height: 200px;
    transform: translate(-50%, -50%);
    background: radial-gradient(
      circle,
      rgba(176, 112, 208, 0.18) 0%,
      transparent 60%
    );
    animation: glow-pulse-2 2s ease-in-out infinite 0.3s;
  }

  .overlay-glow.glow-3 {
    width: 100px;
    height: 100px;
    transform: translate(-50%, -50%);
    background: radial-gradient(
      circle,
      rgba(248, 176, 216, 0.25) 0%,
      transparent 50%
    );
    animation: glow-pulse-3 2s ease-in-out infinite 0.6s;
  }

  @keyframes glow-pulse-1 {
    0%, 100% {
      opacity: 0.5;
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      opacity: 0.8;
      transform: translate(-50%, -50%) scale(1.1);
    }
  }

  @keyframes glow-pulse-2 {
    0%, 100% {
      opacity: 0.6;
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.15);
    }
  }

  @keyframes glow-pulse-3 {
    0%, 100% {
      opacity: 0.7;
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.2);
    }
  }

  /* ============================================
     SIGNATURE
     Subtle scroll-reveal copyright
     ============================================ */

  .signature {
    text-shadow: 0 0 20px rgba(10, 10, 20, 0.8);
  }

  [data-theme="twilight"] .signature {
    text-shadow: 0 0 20px rgba(240, 236, 248, 0.8);
  }

  @media (prefers-reduced-motion: reduce) {
    .overlay-glow {
      animation: none;
    }
    .transition-overlay {
      transition: opacity 0.1s;
    }
    @keyframes emerge-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes emerge-out {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  }
</style>
